name: Security Scanning

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'

# Explicit permissions for security
permissions:
  contents: read
  actions: read
  security-events: write
  pull-requests: read

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install TruffleHog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
      
      - name: Run TruffleHog Git History Scan
        run: |
          trufflehog git https://github.com/${{ github.repository }}.git --branch=${{ github.head_ref || github.ref_name }} --only-verified --json > trufflehog-git.json || true
      
      - name: Run TruffleHog Filesystem Scan
        run: |
          trufflehog filesystem . --only-verified --json > trufflehog-fs.json || true
      
      - name: Run Custom Security Scanner
        run: |
          python security_scan.py || true
      
      - name: Upload TruffleHog Results
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-results
          path: |
            trufflehog-*.json
          retention-days: 30
      
      - name: Check for Security Issues
        run: |
          if [ -s trufflehog-git.json ] || [ -s trufflehog-fs.json ]; then
            echo "ðŸš¨ Security issues found!"
            echo "Git scan results:"
            cat trufflehog-git.json 2>/dev/null || echo "No git scan results"
            echo "Filesystem scan results:"  
            cat trufflehog-fs.json 2>/dev/null || echo "No filesystem scan results"
            exit 1
          else
            echo "âœ… No security issues found"
          fi

  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run Safety (dependency vulnerability scan)
        run: |
          safety check --json --output safety-report.json || true
      
      - name: Run Bandit (Python security linter)
        run: |
          bandit -r . -f json -o bandit-report.json || true
      
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-security-reports
          path: |
            *-report.json
          retention-days: 30
