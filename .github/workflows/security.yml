name: Security Scanning

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'

# Explicit permissions for security
permissions:
  contents: read
  actions: read
  security-events: write
  pull-requests: read

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install TruffleHog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
      
      - name: Run TruffleHog Git History Scan (Local Repository)
        run: |
          trufflehog git file://. --since-commit=HEAD~10 --only-verified --json > trufflehog-git.json || true
      
      - name: Run TruffleHog Filesystem Scan (Local Checkout)
        run: |
          trufflehog filesystem . --only-verified --json > trufflehog-fs.json || true
          
      - name: Run TruffleHog on PR Changes (if applicable)
        if: github.event_name == 'pull_request'
        run: |
          # Scan only the changes in this PR for maximum security
          git fetch origin ${{ github.base_ref }}
          trufflehog git file://. --since-commit=origin/${{ github.base_ref }} --only-verified --json > trufflehog-pr.json || true
      
      - name: Run Custom Security Scanner
        run: |
          python security_scan.py || true
      
      - name: Upload TruffleHog Results
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-results
          path: |
            trufflehog-*.json
          retention-days: 30
      
      - name: Check for Security Issues
        run: |
          echo "üîç Checking TruffleHog scan results..."
          
          # Check git history scan
          if [ -s trufflehog-git.json ]; then
            echo "üö® Security issues found in git history!"
            echo "Git scan results:"
            cat trufflehog-git.json
            SECURITY_ISSUES=true
          else
            echo "‚úÖ No security issues in git history"
          fi
          
          # Check filesystem scan  
          if [ -s trufflehog-fs.json ]; then
            echo "üö® Security issues found in filesystem!"
            echo "Filesystem scan results:"
            cat trufflehog-fs.json
            SECURITY_ISSUES=true
          else
            echo "‚úÖ No security issues in filesystem"
          fi
          
          # Check PR-specific scan (if it exists)
          if [ -f trufflehog-pr.json ] && [ -s trufflehog-pr.json ]; then
            echo "üö® Security issues found in PR changes!"
            echo "PR scan results:"
            cat trufflehog-pr.json
            SECURITY_ISSUES=true
          elif [ -f trufflehog-pr.json ]; then
            echo "‚úÖ No security issues in PR changes"
          fi
          
          # Exit with error if any security issues found
          if [ "$SECURITY_ISSUES" = "true" ]; then
            echo "‚ùå Security scan failed - issues detected!"
            exit 1
          else
            echo "‚úÖ All security scans passed - no issues found"
          fi

  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run Safety (dependency vulnerability scan)
        run: |
          safety check --json --output safety-report.json || true
      
      - name: Run Bandit (Python security linter)
        run: |
          bandit -r . -f json -o bandit-report.json || true
      
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-security-reports
          path: |
            *-report.json
          retention-days: 30
